{
  "description": "A New Flow",
  "states": [
    {
      "name": "Trigger",
      "type": "trigger",
      "transitions": [
        {
          "event": "incomingMessage"
        },
        {
          "event": "incomingCall"
        },
        {
          "event": "incomingConversationMessage"
        },
        {
          "event": "incomingRequest"
        },
        {
          "next": "get_client_information",
          "event": "incomingParent"
        }
      ],
      "properties": {
        "offset": {
          "x": -10,
          "y": -10
        }
      }
    },
    {
      "name": "get_client_information",
      "type": "run-function",
      "transitions": [
        {
          "next": "check_client_was_found",
          "event": "success"
        },
        {
          "event": "fail"
        }
      ],
      "properties": {
        "service_sid": "ZS94a60054fb8b17808bdccffc44d1d2d0",
        "environment_sid": "ZE59c5da4f5ff7e98f2ce35f39df892e5d",
        "offset": {
          "x": -200,
          "y": 210
        },
        "function_sid": "ZHb6dbbfa91efb571020a5d4cd2bddf801",
        "parameters": [
          {
            "value": "phone",
            "key": "typeSearch"
          },
          {
            "value": "{{trigger.parent.parameters.phone}}",
            "key": "clientEmail"
          }
        ],
        "url": "https://serverless-functions-4443-dev.twil.io/hubspot-integration/search-client"
      }
    },
    {
      "name": "check_client_was_found",
      "type": "split-based-on",
      "transitions": [
        {
          "event": "noMatch"
        },
        {
          "next": "check_active_service",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to true",
              "arguments": [
                "{{widgets.get_client_information.parsed.success}}"
              ],
              "type": "equal_to",
              "value": "true"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.get_client_information.parsed.success}}",
        "offset": {
          "x": -420,
          "y": 440
        }
      }
    },
    {
      "name": "check_active_service",
      "type": "split-based-on",
      "transitions": [
        {
          "event": "noMatch"
        },
        {
          "next": "check_business_hours",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "get_client_information.parsed.data.properties.atendimento_ativo_por",
              "arguments": [
                "{{widgets.get_client_information.parsed.data.properties.atendimento_ativo_por}}"
              ],
              "type": "is_not_blank",
              "value": "Is Not Blank"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.get_client_information.parsed.data.properties.atendimento_ativo_por}}",
        "offset": {
          "x": 30,
          "y": 590
        }
      }
    },
    {
      "name": "set_end",
      "type": "set-variables",
      "transitions": [
        {
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "true",
            "key": "endExecution"
          }
        ],
        "offset": {
          "x": -870,
          "y": 2230
        }
      }
    },
    {
      "name": "flex_to_active_service",
      "type": "send-to-flex",
      "transitions": [
        {
          "next": "function_clear_active_service_property",
          "event": "callComplete"
        },
        {
          "next": "fail_to_create_task",
          "event": "failedToEnqueue"
        },
        {
          "event": "callFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 130,
          "y": 2010
        },
        "workflow": "WW45f278b34e59d6f0d8cdadd75e0cc6a2",
        "channel": "TC38f2a7207058a506929181a479717c36",
        "attributes": "{\n \"clientInformation\":{{widgets.get_client_information.parsed.data.properties|to_json}},\n \"assignToEmail\": \"{{widgets.get_client_information.parsed.data.properties.atendimento_ativo_por}}\",\n \"isToAssignToEmail\": \"true\",\n \"customers\": {\n \"phone\": \"{{trigger.message.ChannelAttributes.from | replace: 'whatsapp:', ''}}\",\n \"name\": \"{{widgets.get_client_information.parsed.data.properties.firstname}} {{widgets.get_client_information.parsed.data.properties.lastname}}\",\n \"organization\": \"{{widgets.get_client_information.parsed.data.properties.company}}\",\n \"email\": \"{{widgets.get_client_information.parsed.data.properties.email}}\"\n  },\n \"conversations\": {\n \"external_contact\": \"{{trigger.message.ChannelAttributes.twilioNumber | replace: 'whatsapp:', ''}}\",\n \"selected_option_on_flow\": \"Resposta de um disparo ativo - direcionado para o agente\",\n \"conversation_attribute_2\": \"{{widgets.get_client_information.parsed.data.properties.guardian}}\"\n  }\n}"
      }
    },
    {
      "name": "function_clear_active_service_property",
      "type": "run-function",
      "transitions": [
        {
          "next": "set_end",
          "event": "success"
        },
        {
          "next": "set_end",
          "event": "fail"
        }
      ],
      "properties": {
        "service_sid": "ZS850f086eebae4e5eea92a9d784f731d4",
        "environment_sid": "ZE126c49d9d7faa5140acf3091ac1cb9ac",
        "offset": {
          "x": -870,
          "y": 1890
        },
        "function_sid": "ZH4e86b47c4492d42e524657580cf54928",
        "parameters": [
          {
            "value": "{{widgets.get_client_information.parsed.data.properties.hs_object_id}}",
            "key": "hubspot_id"
          },
          {
            "value": "clear",
            "key": "newNumber"
          },
          {
            "value": "true",
            "key": "messagePropertyValue"
          }
        ],
        "url": "https://serverless-functions-8047-dev.twil.io/hubspot-integration/update-info"
      }
    },
    {
      "name": "check_business_hours",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "split_check_business_hours",
          "event": "success"
        },
        {
          "next": "split_in_hour",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -470,
          "y": 890
        },
        "method": "POST",
        "content_type": "application/json;charset=utf-8",
        "url": "https://serverless-functions-4443-dev.twil.io/utils/check-business-hour"
      }
    },
    {
      "name": "split_check_business_hours",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "split_in_hour",
          "event": "noMatch"
        },
        {
          "next": "split_in_hour",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to true",
              "arguments": ["{{widgets.check_business_hours.parsed.success}}"],
              "type": "equal_to",
              "value": "true"
            }
          ]
        },
        {
          "next": "split_out_of_hour",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to false",
              "arguments": ["{{widgets.check_business_hours.parsed.success}}"],
              "type": "equal_to",
              "value": "false"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.check_business_hours.parsed.success}}",
        "offset": {
          "x": -40,
          "y": 990
        }
      }
    },
    {
      "name": "portuguese_out_of_hours",
      "type": "send-message",
      "transitions": [
        {
          "next": "flex_to_active_service",
          "event": "sent"
        },
        {
          "next": "flex_to_active_service",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 170,
          "y": 1450
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "Olá, no momento estamos fora do horário de atendimento, mas já encaminhei você para o atendimento. Assim que possível retornaremos!"
      }
    },
    {
      "name": "spanish_in_hours",
      "type": "send-message",
      "transitions": [
        {
          "next": "flex_to_active_service",
          "event": "sent"
        },
        {
          "next": "flex_to_active_service",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -260,
          "y": 1450
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "Hola, gracias por contactar a Logcomex. Espere un momento mientras lo dirijo a uno de nuestros asistentes."
      }
    },
    {
      "name": "english_in_hours",
      "type": "send-message",
      "transitions": [
        {
          "next": "flex_to_active_service",
          "event": "sent"
        },
        {
          "next": "flex_to_active_service",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -640,
          "y": 1470
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "Hello, thank you for contacting Logcomex. Please wait a moment while I direct you to one of our attendants."
      }
    },
    {
      "name": "portuguese_in_hours",
      "type": "send-message",
      "transitions": [
        {
          "next": "flex_to_active_service",
          "event": "sent"
        },
        {
          "next": "flex_to_active_service",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1000,
          "y": 1470
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "Olá, obrigado por entrar em contato com a Logcomex. Aguarde um momento enquanto te encaminho para um dos nossos atendentes."
      }
    },
    {
      "name": "english_out_of_hours",
      "type": "send-message",
      "transitions": [
        {
          "next": "flex_to_active_service",
          "event": "sent"
        },
        {
          "next": "flex_to_active_service",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 520,
          "y": 1450
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "Hello, we are currently out of office hours, but I have already forwarded you to service. As soon as possible we will return!"
      }
    },
    {
      "name": "spanish_out_of_hours",
      "type": "send-message",
      "transitions": [
        {
          "next": "flex_to_active_service",
          "event": "sent"
        },
        {
          "next": "flex_to_active_service",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 870,
          "y": 1450
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "Hola, actualmente estamos fuera del horario de oficina, pero ya lo he remitido al servicio. ¡En cuanto podamos volveremos!"
      }
    },
    {
      "name": "split_out_of_hour",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "english_out_of_hours",
          "event": "noMatch"
        },
        {
          "next": "portuguese_out_of_hours",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to BR",
              "arguments": ["{{trigger.parent.parameters.region}}"],
              "type": "equal_to",
              "value": "BR"
            }
          ]
        },
        {
          "next": "spanish_out_of_hours",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to US",
              "arguments": ["{{trigger.parent.parameters.region}}"],
              "type": "equal_to",
              "value": "AR"
            }
          ]
        },
        {
          "next": "english_out_of_hours",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to US",
              "arguments": ["{{trigger.parent.parameters.region}}"],
              "type": "equal_to",
              "value": "US"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{trigger.parent.parameters.region}}",
        "offset": {
          "x": 670,
          "y": 1180
        }
      }
    },
    {
      "name": "split_in_hour",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "portuguese_in_hours",
          "event": "noMatch"
        },
        {
          "next": "portuguese_in_hours",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to AR",
              "arguments": ["{{trigger.parent.parameters.region}}"],
              "type": "equal_to",
              "value": "BR"
            }
          ]
        },
        {
          "next": "english_in_hours",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to US",
              "arguments": ["{{trigger.parent.parameters.region}}"],
              "type": "equal_to",
              "value": "US"
            }
          ]
        },
        {
          "next": "spanish_in_hours",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to AR",
              "arguments": ["{{trigger.parent.parameters.region}}"],
              "type": "equal_to",
              "value": "AR"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{trigger.parent.parameters.region}}",
        "offset": {
          "x": -750,
          "y": 1220
        }
      }
    },
    {
      "name": "fail_to_create_task",
      "type": "send-message",
      "transitions": [
        {
          "next": "set_end",
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -390,
          "y": 2380
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "{%if trigger.parent.parameters.region == \"AR\"%}\nHubo una inestabilidad en el sistema y no fue posible transferir su servicio, por favor contáctenos nuevamente.\n{%else if trigger.parent.parameters.region == \"BR\"%}\nHouve uma instabilidade no sistema e não foi posível transferir o seu atendimento, favor entrar em contato novamente.\n{%else%}\nThere was an instability on our system and it wasn't possible to transfer you to an agent, please contact us again.\n{%endif%}"
      }
    }
  ],
  "initial_state": "Trigger",
  "flags": {
    "allow_concurrent_calls": true
  }
}
