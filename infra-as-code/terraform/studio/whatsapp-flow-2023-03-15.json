{
  "description": "WhatsApp Flow - 15/03/2023",
  "states": [
    {
      "name": "Trigger",
      "type": "trigger",
      "transitions": [
        {
          "next": "setSearchValuePhone",
          "event": "incomingMessage"
        },
        {
          "event": "incomingCall"
        },
        {
          "event": "incomingConversationMessage"
        },
        {
          "event": "incomingRequest"
        },
        {
          "event": "incomingParent"
        }
      ],
      "properties": {
        "offset": {
          "x": -1260,
          "y": -1000
        }
      }
    },
    {
      "name": "isWorking",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "checkIsWorking",
          "event": "success"
        },
        {
          "next": "checkIsWorking",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -360,
          "y": 220
        },
        "method": "POST",
        "content_type": "application/json;charset=utf-8",
        "url": "https://serverless-downtime-manager-8207-dev.twil.io/check-for-downtime"
      }
    },
    {
      "name": "checkIsWorking",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "outBusinessHour",
          "event": "noMatch"
        },
        {
          "next": "validateRegionCode",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to true",
              "arguments": ["{{widgets.isWorking.parsed.isWorking}}"],
              "type": "equal_to",
              "value": "true"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.isWorking.parsed.isWorking}}",
        "offset": {
          "x": -10,
          "y": 210
        }
      }
    },
    {
      "name": "outBusinessHour",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -370,
          "y": 530
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nNosso horário de funcionamento é de segunda à sexta, das 08h às 18h, por isso, não temos nenhum agente disponível no momento. Mas você pode nos contatar no e-mail: guardioes@logcomex.com ou suporte.logcomex.com\n{% when \" AR\" or \"AR\" %}\nNuestro horario de atención es de lunes a viernes, de 08:00 a 18:00, por lo tanto, no tenemos ningún agente disponible en este momento. Pero puede contactarnos por correo electrónico: guardioes@logcomex.com o suporte.logcomex.com\n{% else %}\nOur opening hours are from Monday to Friday, from 08:00 to 18:00, therefore, we do not have any agents available at the moment. But you can contact us via email: guardioes@logcomex.com or suporte.logcomex.com\n{% endcase %}"
      }
    },
    {
      "name": "mainMenuSelect",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "mainMenu",
          "event": "noMatch"
        },
        {
          "next": "verifyDeal",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to 1,1-,one, 1,1., 1-,One,",
              "arguments": ["{{widgets.mainMenu.inbound.Body}}"],
              "type": "matches_any_of",
              "value": "1,1-,one, 1,1., 1-,One,Falar,Descubre,Talk,falar,descubre,talk"
            }
          ]
        },
        {
          "next": "validateHSContact",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to 2,2-,two, 2,2., 2-,Two,",
              "arguments": ["{{widgets.mainMenu.inbound.Body}}"],
              "type": "matches_any_of",
              "value": "2,2-,two, 2,2., 2-,Two,Habla,Descubre,Discover,conhecer,habla,discover"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.mainMenu.inbound.Body}}",
        "offset": {
          "x": -10,
          "y": 1510
        }
      }
    },
    {
      "name": "verifyDeal",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "notConteinDeal",
          "event": "noMatch"
        },
        {
          "next": "containDeal",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value greater_than 0",
              "arguments": [
                "{{widgets.get_client_information.parsed.data.properties.num_associated_deals}}"
              ],
              "type": "greater_than",
              "value": "0"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.get_client_information.parsed.data.properties.num_associated_deals}}",
        "offset": {
          "x": -520,
          "y": 1850
        }
      }
    },
    {
      "name": "containDeal",
      "type": "send-message",
      "transitions": [
        {
          "next": "setSubjectSDR",
          "event": "sent"
        },
        {
          "next": "setSubjectSDR",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -190,
          "y": 2190
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nLegal, aguarde que em breve um de nossos especialistas dará continuidade na sua tratativa\n{% when \" AR\" or \"AR\" %}\nGenial, espera a que uno de nuestros especialistas continúe con tus gestiones pronto\n{% else %}\nCool, wait for one of our specialists to continue with your negotiations soon\n{% endcase %}"
      }
    },
    {
      "name": "sendToFlex",
      "type": "send-to-flex",
      "transitions": [
        {
          "event": "callComplete"
        },
        {
          "event": "failedToEnqueue"
        },
        {
          "event": "callFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 250,
          "y": 2500
        },
        "workflow": "WWfcbc3317b162e102e4165f32a71e29c9",
        "channel": "TC38f2a7207058a506929181a479717c36",
        "attributes": "{\n\"subject\": \"{{flow.variables.subject}}\",\n{%if widgets.get_client_information.parsed.success %}\n\"clientInformation\":{{widgets.get_client_information.parsed.data.properties|to_json}},\n{%endif%}\n\"customers\": {\n\"phone\": \"{{trigger.message.ChannelAttributes.from | replace: 'whatsapp:', ''}}\",\n{%if widgets.get_client_information.parsed.success%}\n\"name\": \"{{widgets.get_client_information.parsed.data.properties.firstname}} {{widgets.get_client_information.parsed.data.properties.lastname}}\",\n\"organization\": \"{% if widgets.get_client_information.parsed.data.properties.company %}{{widgets.get_client_information.parsed.data.properties.company}}{% else %}Contato sem empresa vinculada{% endif %}\",\n\"email\": \"{% if widgets.get_client_information.parsed.data.properties.email %}{{widgets.get_client_information.parsed.data.properties.email}}{% else %}Contato sem email vinculado{% endif %}\",\n\"customer_attribute_1\": \"{% if widgets.get_client_information.parsed.data.properties.guardian %}{{widgets.get_client_information.parsed.data.properties.guardian}}{% else %}Contato sem guardião vinculado{% endif %}\"\n{%else%}\n\"name\": \"{{trigger.message.ChannelAttributes.from}}\",\n\"organization\": \"Cliente não encontrado\",\n\"email\": \"Cliente não encontrado\",\n\"customer_attribute_1\": \"Cliente não encontrado\"\n{%endif%}\n},\n\"conversations\": {\n\"external_contact\": \"{{trigger.message.ChannelAttributes.twilioNumber | replace: 'whatsapp:', ''}}\",\n\"selected_option_on_flow\": \"{{flow.variables.optionFlow}}\",\n\"conversation_attribute_9\": \"{{flow.variables.optionFlow}}\"\n}\n}"
      }
    },
    {
      "name": "notConteinDeal",
      "type": "send-message",
      "transitions": [
        {
          "next": "continuingOurConversation",
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -780,
          "y": 2190
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nAgora, precisamos de algumas informações suas. É rapidinho⚡️\n{% when \" AR\" or \"AR\" %}\nAhora, necesitamos alguna información de usted. Es rápido⚡️\n{% else %}\nNow, we need some information from you. It's quick⚡️\n{% endcase %}"
      }
    },
    {
      "name": "mainMenu",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "mainMenuSelect",
          "event": "incomingMessage"
        },
        {
          "next": "TheEnd",
          "event": "timeout"
        },
        {
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 400,
          "y": 920
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nOlá! Este é o WhatsApp da Logcomex\nhttps://www.logcomex.com/ \n\nComo podemos te ajudar? \n1 - Conhecer nossos produtos\n2 - Falar sobre sua assinatura\n{% when \" AR\" or \"AR\" %}\n¡Hola! Este es Logcomex WhatsApp\n¿Qué necesitas?\n\n1 - Descubre nuestros productos\n2 - Habla sobre tu suscripción\n{% else %}\nHello! This is Logcomex WhatsApp\nWhat do you need?\n\n1 - Discover our products\n2 - Talk about your signature\n{% endcase %}",
        "timeout": "1800"
      }
    },
    {
      "name": "verifyEmail",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "setSearchValueEmail",
          "event": "incomingMessage"
        },
        {
          "next": "TheEnd",
          "event": "timeout"
        },
        {
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 1200,
          "y": 1830
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nPoderia me informar seu e-mail cadastrado na plataforma?\n{% when \" AR\" or \"AR\" %}\n¿Podría decirme su correo electrónico registrado en la plataforma?\n{% else %}\nCould you tell me your email registered on the platform?\n{% endcase %}",
        "timeout": "1800"
      }
    },
    {
      "name": "continuingOurConversation",
      "type": "send-message",
      "transitions": [
        {
          "next": "setCount1",
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -780,
          "y": 2500
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\n_Ao continuar nossa conversa, você concorda em permitir que a Logcomex armazene e processe as informações pessoais enviadas para fornecer o atendimento solicitado_\n{% when \" AR\" or \"AR\" %}\n_Al continuar con nuestra conversación, acepta permitir que Logcomex almacene y procese la información personal enviada para proporcionar el servicio solicitado_\n{% else %}\n_By continuing our conversation, you agree to allow Logcomex to store and process the personal information sent to provide the requested service_\n{% endcase %}"
      }
    },
    {
      "name": "getName",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "setCount2",
          "event": "incomingMessage"
        },
        {
          "next": "verifyCountName",
          "event": "timeout"
        },
        {
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": -770,
          "y": 3030
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nQual seu nome?\n{% when \" AR\" or \"AR\" %}\n¿Cuál es tu nombre?\n{% else %}\nWhat is your name?\n{% endcase %}",
        "timeout": "900"
      }
    },
    {
      "name": "timeOutName1",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1230,
          "y": 3320
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nOk. Até a próxima 👋\n{% when \" AR\" or \"AR\" %}\nDE ACUERDO. Hasta la próxima 👋\n{% else %}\nOK. See you next time 👋\n{% endcase %}"
      }
    },
    {
      "name": "getEmail",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "setCount3",
          "event": "incomingMessage"
        },
        {
          "next": "verifyCountEmail",
          "event": "timeout"
        },
        {
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": -750,
          "y": 3970
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nE seu e-mail?\n{% when \" AR\" or \"AR\" %}\n¿Y tu correo electrónico?\n{% else %}\nAnd your email?\n{% endcase %}",
        "timeout": "900"
      }
    },
    {
      "name": "timeOutEmail1",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1220,
          "y": 4250
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nOk. Até a próxima 👋\n{% when \" AR\" or \"AR\" %}\nDE ACUERDO. Hasta la próxima 👋\n{% else %}\nOK. See you next time 👋\n{% endcase %}"
      }
    },
    {
      "name": "verifyClientInformation",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "getName1",
          "event": "noMatch"
        },
        {
          "next": "getName1",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to false",
              "arguments": [
                "{{widgets.get_client_information.parsed.success}}"
              ],
              "type": "equal_to",
              "value": "false"
            }
          ]
        },
        {
          "next": "httpUpdateLanguage",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to true",
              "arguments": [
                "{{widgets.get_client_information.parsed.success}}"
              ],
              "type": "equal_to",
              "value": "true"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.get_client_information.parsed.success}}",
        "offset": {
          "x": 920,
          "y": 2400
        }
      }
    },
    {
      "name": "getName1",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "getCompany1",
          "event": "incomingMessage"
        },
        {
          "next": "TheEnd",
          "event": "timeout"
        },
        {
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 710,
          "y": 2710
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nNão consegui encontrar seu cadastro. Mas não se preocupe, vou te transferir para um atendente.\n\nPoderia me confirmar seu nome?\n{% when \" AR\" or \"AR\" %}\nNo pude encontrar tu registro. Pero no te preocupes, te transferiré a un asistente.\n\n¿Podrías confirmar tu nombre?\n{% else %}\nI couldn't find your record. But don't worry, I'll transfer you to an attendant.\n\nCould you confirm your name?\n{% endcase %}",
        "timeout": "1800"
      }
    },
    {
      "name": "getCompany1",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "setSubjectOption2NotCustomer",
          "event": "incomingMessage"
        },
        {
          "next": "TheEnd",
          "event": "timeout"
        },
        {
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 470,
          "y": 3000
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nE o nome da empresa?\n{% when \" AR\" or \"AR\" %}\ny el nombre de la empresa?\n{% else %}\nAnd the name of the company?\n{% endcase %}",
        "timeout": "1800"
      }
    },
    {
      "name": "comparePhone",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "updatePhone",
          "event": "noMatch"
        },
        {
          "next": "checkClassificationOfCliente",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to {{trigger.message.ChannelAttributes.from | replace:'whatsapp:', ''}}",
              "arguments": [
                "{{widgets.get_client_information.parsed.data.phone}}"
              ],
              "type": "equal_to",
              "value": "{{trigger.message.ChannelAttributes.from | replace:'whatsapp:', ''}}"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.get_client_information.parsed.data.phone}}",
        "offset": {
          "x": 1570,
          "y": 2720
        }
      }
    },
    {
      "name": "updatePhone",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "selectIfUpdatePhone",
          "event": "incomingMessage"
        },
        {
          "next": "TheEnd",
          "event": "timeout"
        },
        {
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 1200,
          "y": 2990
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nVimos que está usando um número diferente do cadastrado.\nQuer atualizar para *{{trigger.message.ChannelAttributes.from | replace:'whatsapp:', ''}}*?\n\n1 - Sim\n2 - Não\n{% when \" AR\" or \"AR\" %}\nVemos que está utilizando un número diferente al registrado.\nQuiere actualizar a *{{trigger.message.ChannelAttributes.from | replace:'whatsapp:', ''}}*?\n\n1 - Si\n2 - No\n{% else %}\nWe see that you are using a different number than the registered one.\nWant to update to *{{trigger.message.ChannelAttributes.from | replace:'whatsapp:', ''}}*?\n\n1 - yes\n2 - No\n{% endcase %}",
        "timeout": "1800"
      }
    },
    {
      "name": "selectIfUpdatePhone",
      "type": "split-based-on",
      "transitions": [
        {
          "event": "noMatch"
        },
        {
          "next": "updatingPhone",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to 1, 1,1-,1.,Sim,Yes,",
              "arguments": ["{{widgets.updatePhone.inbound.Body}}"],
              "type": "matches_any_of",
              "value": "1, 1,1-,1.,Sim,Yes,Si,sim,yes,si,"
            }
          ]
        },
        {
          "next": "validateKA",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to 2, 2,2-,2.,Não,Nao,No,sim,yes,si,",
              "arguments": ["{{widgets.updatePhone.inbound.Body}}"],
              "type": "matches_any_of",
              "value": "2, 2,2-,2.,Não,Nao,No,não,nao,no"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.updatePhone.inbound.Body}}",
        "offset": {
          "x": 1210,
          "y": 3310
        }
      }
    },
    {
      "name": "updatingPhone",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "validateKA",
          "event": "success"
        },
        {
          "next": "validateKA",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1350,
          "y": 3650
        },
        "method": "POST",
        "content_type": "application/json;charset=utf-8",
        "body": "{\n\"hubspot_id\": \"{{widgets.get_client_information.parsed.data.properties.hs_object_id}}\",\n\"newNumber\": \" {{trigger.message.ChannelAttributes.from}}\"\n}",
        "url": "https://serverless-functions-4443-dev.twil.io/hubspot-integration/update-info"
      }
    },
    {
      "name": "checkClassificationOfCliente",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "validateKA",
          "event": "noMatch"
        },
        {
          "next": "setSubjectOption2CustomerWithoutClassification",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value not_equal_to null",
              "arguments": [
                "{{widgets.get_client_information.parsed.data.classificacao_do_cliente}}"
              ],
              "type": "not_equal_to",
              "value": "null"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.get_client_information.parsed.data.classificacao_do_cliente}}",
        "offset": {
          "x": 2300,
          "y": 2980
        }
      }
    },
    {
      "name": "queueOptionsMenu",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "selectQueueOption",
          "event": "incomingMessage"
        },
        {
          "next": "TheEnd",
          "event": "timeout"
        },
        {
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 2330,
          "y": 3310
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nEm que podemos te ajudar?\n\n1 - Preciso falar com um guardião sobre meu plano ou contratar uma nova funcionalidade\n2 - Quero tratar da renovação de contrato\n3 - Quero falar com o suporte\n4 - Preciso falar com o financeiro\n{% when \" AR\" or \"AR\" %}\ncomo podemos ayudarte?\n\n1 - Necesito hablar con un tutor sobre mi plan o contratar una nueva función\n2 - Quiero hacer frente a la renovación del contrato\n3 - Quiero hablar con soporte\n4 - Necesito hablar con finanzas\n{% else %}\nHow can we help you?\n\n1 - I need to talk to a guardian about my plan or hire a new feature\n2 - I want to deal with the renewal of the contract\n3 - I want to talk to support\n4 - I need to talk to finance\n{% endcase %}",
        "timeout": "1800"
      }
    },
    {
      "name": "setCount1",
      "type": "set-variables",
      "transitions": [
        {
          "next": "getName",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "1",
            "key": "count"
          }
        ],
        "offset": {
          "x": -780,
          "y": 2760
        }
      }
    },
    {
      "name": "verifyCountName",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "refreshCount1",
          "event": "noMatch"
        },
        {
          "next": "timeOutName1",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value greater_than 1",
              "arguments": ["{{flow.variables.count}}"],
              "type": "greater_than",
              "value": "1"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{flow.variables.count}}",
        "offset": {
          "x": -1270,
          "y": 3040
        }
      }
    },
    {
      "name": "refreshCount1",
      "type": "set-variables",
      "transitions": [
        {
          "next": "timeOutName",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "2",
            "key": "count"
          }
        ],
        "offset": {
          "x": -1680,
          "y": 3050
        }
      }
    },
    {
      "name": "timeOutName",
      "type": "send-message",
      "transitions": [
        {
          "next": "getName",
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1250,
          "y": 2770
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nSeu tempo de resposta está expirando. Se quiser continuar o atendimento, insira seu nome\n{% when \" AR\" or \"AR\" %}\nSu tiempo de respuesta está expirando. Si desea continuar con el servicio, ingrese su nombre\n{% else %}\nYour response time is expiring. If you want to continue the service, enter your name\n{% endcase %}"
      }
    },
    {
      "name": "setCount2",
      "type": "set-variables",
      "transitions": [
        {
          "next": "getEmail",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "1",
            "key": "count"
          }
        ],
        "offset": {
          "x": -760,
          "y": 3690
        }
      }
    },
    {
      "name": "refreshCount2",
      "type": "set-variables",
      "transitions": [
        {
          "next": "timeOutEmail",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "2",
            "key": "count"
          }
        ],
        "offset": {
          "x": -1690,
          "y": 3980
        }
      }
    },
    {
      "name": "verifyCountEmail",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "refreshCount2",
          "event": "noMatch"
        },
        {
          "next": "timeOutEmail1",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value greater_than 1",
              "arguments": ["{{flow.variables.count}}"],
              "type": "greater_than",
              "value": "1"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{flow.variables.count}}",
        "offset": {
          "x": -1250,
          "y": 3970
        }
      }
    },
    {
      "name": "timeOutEmail",
      "type": "send-message",
      "transitions": [
        {
          "next": "getEmail",
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1230,
          "y": 3690
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nSeu tempo de resposta está expirando. Se quiser continuar o atendimento, insira seu e-mail\n{% when \" AR\" or \"AR\" %}\nSu tiempo de respuesta está expirando. Si desea continuar con el servicio, ingrese su correo electrónico\n{% else %}\nYour response time is expiring. If you want to continue the service, enter your email\n{% endcase %}"
      }
    },
    {
      "name": "setCount3",
      "type": "set-variables",
      "transitions": [
        {
          "next": "getSegment",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "1",
            "key": "count"
          }
        ],
        "offset": {
          "x": -750,
          "y": 4630
        }
      }
    },
    {
      "name": "verifyCountSegment",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "refreshCount3",
          "event": "noMatch"
        },
        {
          "next": "timeOutSegment1",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value greater_than 1",
              "arguments": ["{{flow.variables.count}}"],
              "type": "greater_than",
              "value": "1"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{flow.variables.count}}",
        "offset": {
          "x": -1230,
          "y": 4930
        }
      }
    },
    {
      "name": "getSegment",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "setCount4",
          "event": "incomingMessage"
        },
        {
          "next": "verifyCountSegment",
          "event": "timeout"
        },
        {
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": -740,
          "y": 4920
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nQual é seu segmento?\n{% when \" AR\" or \"AR\" %}\n¿Cuál es tu segmento?\n{% else %}\nWhat is your segment?\n{% endcase %}",
        "timeout": "900"
      }
    },
    {
      "name": "refreshCount3",
      "type": "set-variables",
      "transitions": [
        {
          "next": "timeOutSegment",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "2",
            "key": "count"
          }
        ],
        "offset": {
          "x": -1690,
          "y": 4940
        }
      }
    },
    {
      "name": "timeOutSegment",
      "type": "send-message",
      "transitions": [
        {
          "next": "getSegment",
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1200,
          "y": 4640
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nSeu tempo de resposta está expirando. Se quiser continuar o atendimento, insira seu segmento\n{% when \" AR\" or \"AR\" %}\nSu tiempo de respuesta está expirando. Si desea continuar con el servicio, ingrese su segmento\n{% else %}\nYour response time is expiring. If you want to continue the service, enter your segment\n{% endcase %}"
      }
    },
    {
      "name": "timeOutSegment1",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1180,
          "y": 5160
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nOk. Até a próxima 👋\n{% when \" AR\" or \"AR\" %}\nDE ACUERDO. Hasta la próxima 👋\n{% else %}\nOK. See you next time 👋\n{% endcase %}"
      }
    },
    {
      "name": "setCount4",
      "type": "set-variables",
      "transitions": [
        {
          "next": "getCompany",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "1",
            "key": "count"
          }
        ],
        "offset": {
          "x": -710,
          "y": 5570
        }
      }
    },
    {
      "name": "timeOutCompany",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1160,
          "y": 5580
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nSeu tempo de resposta está expirando. Se quiser continuar o atendimento, insira a empresa que você trabalha\n{% when \" AR\" or \"AR\" %}\nSu tiempo de respuesta está expirando. Si desea continuar con el servicio, ingrese la empresa para la que trabaja\n{% else %}\nYour response time is expiring. If you want to continue the service, enter the company you work for\n{% endcase %}"
      }
    },
    {
      "name": "refreshCount4",
      "type": "set-variables",
      "transitions": [
        {
          "next": "timeOutCompany",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "2",
            "key": "count"
          }
        ],
        "offset": {
          "x": -1650,
          "y": 5880
        }
      }
    },
    {
      "name": "verifyCountCompany",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "refreshCount4",
          "event": "noMatch"
        },
        {
          "next": "timeOutCompany1",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value greater_than 1",
              "arguments": ["{{flow.variables.count}}"],
              "type": "greater_than",
              "value": "1"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{flow.variables.count}}",
        "offset": {
          "x": -1190,
          "y": 5870
        }
      }
    },
    {
      "name": "getCompany",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "endOfDataCollection",
          "event": "incomingMessage"
        },
        {
          "next": "verifyCountCompany",
          "event": "timeout"
        },
        {
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": -700,
          "y": 5860
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nÚltima perguntinha: qual o nome da empresa que você trabalha?\n{% when \" AR\" or \"AR\" %}\nÚltima pregunta: ¿cuál es el nombre de la empresa para la que trabaja?\n{% else %}\nLast question: what is the name of the company you work for?\n{% endcase %}",
        "timeout": "900"
      }
    },
    {
      "name": "timeOutCompany1",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1150,
          "y": 6130
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nOk. Até a próxima 👋\n{% when \" AR\" or \"AR\" %}\nDE ACUERDO. Hasta la próxima 👋\n{% else %}\nOK. See you next time 👋\n{% endcase %}"
      }
    },
    {
      "name": "endOfDataCollection",
      "type": "send-message",
      "transitions": [
        {
          "next": "Copy_of_setSubjectSDR",
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -190,
          "y": 5870
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nObrigado por enviar suas informações. Aguarde um pouquinho enquanto eu encontro um atendente para você\n{% when \" AR\" or \"AR\" %}\nGracias por enviar su información. Espere un momento mientras encuentro un agente para usted.\n{% else %}\nThank you for submitting your information. Please wait a while while I find an agent for you.\n{% endcase %}"
      }
    },
    {
      "name": "selectQueueOption",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "sendMessageIncorrectOption",
          "event": "noMatch"
        },
        {
          "next": "httpGuardianActivity",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "1",
              "arguments": ["{{widgets.queueOptionsMenu.inbound.Body}}"],
              "type": "equal_to",
              "value": "1"
            }
          ]
        },
        {
          "next": "setSubjectSupport",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "2",
              "arguments": ["{{widgets.queueOptionsMenu.inbound.Body}}"],
              "type": "equal_to",
              "value": "2"
            }
          ]
        },
        {
          "next": "setSubjectSupport",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "3",
              "arguments": ["{{widgets.queueOptionsMenu.inbound.Body}}"],
              "type": "equal_to",
              "value": "3"
            }
          ]
        },
        {
          "next": "setSubjectFinancial",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "4",
              "arguments": ["{{widgets.queueOptionsMenu.inbound.Body}}"],
              "type": "equal_to",
              "value": "4"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.queueOptionsMenu.inbound.Body}}",
        "offset": {
          "x": 2540,
          "y": 3630
        }
      }
    },
    {
      "name": "sendToLogger",
      "type": "send-message",
      "transitions": [
        {
          "next": "sendToFlex",
          "event": "sent"
        },
        {
          "next": "sendToFlex",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 2710,
          "y": 4290
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nAguarde um um instante enquanto eu encontro um logger para te atender\n{% when \" AR\" or \"AR\" %}\nEspera un momento mientras busco un registrador para ayudarte\n{% else %}\nWait a moment while I find a logger to assist you\n{% endcase %}"
      }
    },
    {
      "name": "validateSearchByEmail",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "validateTestAthan",
          "event": "noMatch"
        },
        {
          "next": "verifyClientInformation",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "true",
              "arguments": ["{{flow.variables.typeSearch}}"],
              "type": "equal_to",
              "value": "email"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{flow.variables.typeSearch}}",
        "offset": {
          "x": -790,
          "y": -620
        }
      }
    },
    {
      "name": "setSearchValueEmail",
      "type": "set-variables",
      "transitions": [
        {
          "next": "get_client_information",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "email",
            "key": "typeSearch"
          },
          {
            "value": "{{widgets.verifyEmail.inbound.Body}}",
            "key": "value"
          }
        ],
        "offset": {
          "x": 810,
          "y": 1840
        }
      }
    },
    {
      "name": "messageSelectRegion",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "setRegionCodeWithoutContact",
          "event": "incomingMessage"
        },
        {
          "next": "setRegionCodeWithoutContact",
          "event": "timeout"
        },
        {
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 770,
          "y": 210
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "body": "This conversation will be in English.\n\nWant to select another language?\n\n1- Se quer continuar em português\n2 - If you want to continue in English\n3 - Si quieres continuar en español",
        "timeout": "1800"
      }
    },
    {
      "name": "setRegionCodeWithoutContact",
      "type": "set-variables",
      "transitions": [
        {
          "next": "mainMenu",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "{% if widgets.messageSelectRegion.inbound.Body == \"1\" %}BR{% elsif widgets.messageSelectRegion.inbound.Body == \"2\" %}US{% elsif widgets.messageSelectRegion.inbound.Body == \"3\" %}AR{% else %} unset{% endif %}",
            "key": "regionCode"
          }
        ],
        "offset": {
          "x": 780,
          "y": 480
        }
      }
    },
    {
      "name": "validateHSContact",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "verifyEmail",
          "event": "noMatch"
        },
        {
          "next": "validateKA",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "true",
              "arguments": [
                "{{widgets.get_client_information.parsed.success}}"
              ],
              "type": "equal_to",
              "value": "true"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.get_client_information.parsed.success}}",
        "offset": {
          "x": 680,
          "y": 1510
        }
      }
    },
    {
      "name": "httpUpdateLanguage",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "comparePhone",
          "event": "success"
        },
        {
          "next": "comparePhone",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1440,
          "y": 2400
        },
        "method": "POST",
        "content_type": "application/json;charset=utf-8",
        "body": "{\n\"hubspot_id\":\"{{widgets.get_client_information.parsed.data.properties.hs_object_id}}\",\n\"language\":\"{{flow.variables.regionCode}}\"\n}",
        "url": "https://serverless-functions-4443-dev.twil.io/hubspot-integration/save-language"
      }
    },
    {
      "name": "httpGuardianActivity",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "setSubjectGuardian",
          "event": "success"
        },
        {
          "next": "setSubjectGuardian",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 2940,
          "y": 3630
        },
        "method": "POST",
        "content_type": "application/json;charset=utf-8",
        "body": "{\n\"workerEmail\":\"{{widgets.get_client_information.parsed.data.properties.guardian}}\"\n}",
        "url": "https://serverless-functions-4443-dev.twil.io/utils/validate-worker-available"
      }
    },
    {
      "name": "setSubjectSupport",
      "type": "set-variables",
      "transitions": [
        {
          "next": "sendToLogger",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "send-to-Suporte_SMB_1_Analytics",
            "key": "subject"
          },
          {
            "value": "{% case widgets.queueOptionsMenu.inbound.Body %}{% when \"2\" %}2 - Quero tratar da renovação de contrato{% when \"3\" %}{% else %}3 - Quero falar com o suporte{% endcase %}",
            "key": "optionFlow"
          }
        ],
        "offset": {
          "x": 2150,
          "y": 3920
        }
      }
    },
    {
      "name": "setSubjectFinancial",
      "type": "set-variables",
      "transitions": [
        {
          "next": "sendToLogger",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "send-to-Financeiro",
            "key": "subject"
          },
          {
            "value": "4 - Preciso falar com o financeiro",
            "key": "optionFlow"
          }
        ],
        "offset": {
          "x": 2840,
          "y": 3920
        }
      }
    },
    {
      "name": "sendMessageIncorrectOption",
      "type": "send-message",
      "transitions": [
        {
          "next": "setSubjectSupport",
          "event": "sent"
        },
        {
          "next": "setSubjectSupport",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 2120,
          "y": 3640
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "Não identificamos a opção selecionada, então vou conectar você com nosso time de suporte, assim podemos te ajudar melhor!"
      }
    },
    {
      "name": "TheEnd",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 3320,
          "y": 1580
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nObrigado por entrar em contato com a Logcomex! Para conversar conosco novamente, basta enviar uma mensagem.\n{% when \" AR\" or \"AR\" %}\n¡Gracias por contactar a Logcomex! Para chatear con nosotros nuevamente, solo envíenos un mensaje.\n{% else %}\nThank you for contacting Logcomex! To chat with us again, just send us a message.\n{% endcase %}"
      }
    },
    {
      "name": "athsIntegration",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "athsIntegrationCheck",
          "event": "success"
        },
        {
          "next": "athsIntegrationCheck",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -2160,
          "y": 100
        },
        "method": "POST",
        "content_type": "application/json;charset=utf-8",
        "body": "{ \"clientNumber\": \"{{trigger.message.ChannelAttributes.from}}\", \"companyNumber\": \"{{trigger.message.ChannelAttributes.twilioNumber}}\", \"channelSid\": \"{{trigger.message.ChannelSid}}\", \"chatServiceSid\": \"{{trigger.message.InstanceSid}}\" }",
        "url": "https://serverless-functions-4443-dev.twil.io/integrations/aths/aths-integration"
      }
    },
    {
      "name": "athsIntegrationCheck",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "isWorkingTemplate",
          "event": "noMatch"
        },
        {
          "next": "setAthsVariables",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to true",
              "arguments": ["{{widgets.athsIntegration.parsed.success}}"],
              "type": "equal_to",
              "value": "true"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.athsIntegration.parsed.success}}",
        "offset": {
          "x": -2130,
          "y": 370
        }
      }
    },
    {
      "name": "setAthsVariables",
      "type": "set-variables",
      "transitions": [
        {
          "next": "sendToFlexATHS",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "{%if widgets.athsIntegration.parsed.data.type_studio_integration == \"agent\" %}worker{%else%}queue{%endif%}",
            "key": "transferTargetType"
          },
          {
            "value": "Resposta de um disparo em massa ATHS",
            "key": "optionFlow"
          },
          {
            "value": "{{widgets.athsIntegration.parsed.data.studio_integration_route}}",
            "key": "targetSid"
          }
        ],
        "offset": {
          "x": -1940,
          "y": 640
        }
      }
    },
    {
      "name": "sendToFlexATHS",
      "type": "send-to-flex",
      "transitions": [
        {
          "event": "callComplete"
        },
        {
          "event": "failedToEnqueue"
        },
        {
          "event": "callFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": -2110,
          "y": 940
        },
        "workflow": "WW0ee76b16197f7eb3b936f8450ed66b60",
        "channel": "TC38f2a7207058a506929181a479717c36",
        "attributes": "{\n\"transferTargetType\": \"{{flow.variables.transferTargetType}}\",\n\"targetSid\": \"{{flow.variables.targetSid}}\",\n{%if widgets.get_client_information.parsed.success %}\n\"clientInformation\":{{widgets.get_client_information.parsed.data.properties|to_json}},\n{%endif%}\n\"customers\": {\n\"phone\": \"{{trigger.message.ChannelAttributes.from | replace: 'whatsapp:', ''}}\",\n{%if widgets.get_client_information.parsed.success%}\n\"name\": \"{{widgets.get_client_information.parsed.data.properties.firstname}} {{widgets.get_client_information.parsed.data.properties.lastname}}\",\n\"organization\": \"{% if widgets.get_client_information.parsed.data.properties.company %}{{widgets.get_client_information.parsed.data.properties.company}}{% else %}Contato sem empresa vinculada{% endif %}\",\n\"email\": \"{% if widgets.get_client_information.parsed.data.properties.email %}{{widgets.get_client_information.parsed.data.properties.email}}{% else %}Contato sem email vinculado{% endif %}\",\n\"customer_attribute_1\": \"{% if widgets.get_client_information.parsed.data.properties.guardian %}{{widgets.get_client_information.parsed.data.properties.guardian}}{% else %}Contato sem guardião vinculado{% endif %}\"\n{%else%}\n\"name\": \"{{trigger.message.ChannelAttributes.from}}\",\n\"organization\": \"Cliente não encontrado\",\n\"email\": \"Cliente não encontrado\",\n\"customer_attribute_1\": \"Cliente não encontrado\"\n{%endif%}\n},\n\"conversations\": {\n\"external_contact\": \"{{trigger.message.ChannelAttributes.twilioNumber | replace: 'whatsapp:', ''}}\",\n\"selected_option_on_flow\": \"{{flow.variables.optionFlow}}\",\n\"conversation_attribute_9\": \"{{flow.variables.optionFlow}}\"\n}\n}"
      }
    },
    {
      "name": "validate-comes-from-template",
      "type": "run-function",
      "transitions": [
        {
          "next": "split_validate-comes-from-template",
          "event": "success"
        },
        {
          "next": "split_validate-comes-from-template",
          "event": "fail"
        }
      ],
      "properties": {
        "service_sid": "ZS94a60054fb8b17808bdccffc44d1d2d0",
        "environment_sid": "ZE59c5da4f5ff7e98f2ce35f39df892e5d",
        "offset": {
          "x": -2900,
          "y": 410
        },
        "function_sid": "ZHbb821275c9a27353b5e6b82ff5ee9215",
        "parameters": [
          {
            "value": "{{widgets.get_client_information.parsed.data.properties.atendimento_ativo_por}}",
            "key": "workerEmail"
          },
          {
            "value": "{{widgets.get_client_information.parsed.data.properties.hs_object_id}}",
            "key": "hubspotId"
          },
          {
            "value": "{{trigger.message.ChannelAttributes.proxySession}}",
            "key": "sessionSid"
          }
        ],
        "url": "https://serverless-functions-4443-dev.twil.io/hubspot-integration/validate-comes-from-template"
      }
    },
    {
      "name": "split_validate-comes-from-template",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "isWorking",
          "event": "noMatch"
        },
        {
          "next": "checkIsWorkingTemplate",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "queue",
              "arguments": [
                "{{widgets.validate-comes-from-template.parsed.to}}"
              ],
              "type": "equal_to",
              "value": "queue"
            }
          ]
        },
        {
          "next": "checkIsWorkingTemplateWorker",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "worker",
              "arguments": [
                "{{widgets.validate-comes-from-template.parsed.to}}"
              ],
              "type": "equal_to",
              "value": "worker"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.validate-comes-from-template.parsed.to}}",
        "offset": {
          "x": -2900,
          "y": 670
        }
      }
    },
    {
      "name": "isWorkingTemplate",
      "type": "run-function",
      "transitions": [
        {
          "next": "validate-comes-from-template",
          "event": "success"
        },
        {
          "next": "validate-comes-from-template",
          "event": "fail"
        }
      ],
      "properties": {
        "service_sid": "ZS6dfd3ba3686bb3fb7a0a5fe1bf51ae09",
        "environment_sid": "ZE6ce58c4ff44e3414e02d8598280ebd6c",
        "offset": {
          "x": -2530,
          "y": 400
        },
        "function_sid": "ZH07f30cac54b31d12a419654de3611258",
        "url": "https://serverless-downtime-manager-8207-dev.twil.io/check-for-downtime"
      }
    },
    {
      "name": "checkIsWorkingTemplate",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "outBusinessHour",
          "event": "noMatch"
        },
        {
          "next": "setSubjectTemplate",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to true",
              "arguments": ["{{widgets.isWorkingTemplate.parsed.isWorking}}"],
              "type": "equal_to",
              "value": "true"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.isWorkingTemplate.parsed.isWorking}}",
        "offset": {
          "x": -3400,
          "y": 1000
        }
      }
    },
    {
      "name": "get_client_information",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "validateSearchByEmail",
          "event": "success"
        },
        {
          "next": "validateSearchByEmail",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1160,
          "y": -620
        },
        "method": "POST",
        "content_type": "application/json;charset=utf-8",
        "body": "{\n\"typeSearch\": \"{{flow.variables.typeSearch}}\",\n\"clientEmail\": \"{{flow.variables.value}}\"\n}",
        "url": "https://serverless-functions-4443-dev.twil.io/hubspot-integration/search-client"
      }
    },
    {
      "name": "validateTestAthan",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "get_client_ddi",
          "event": "noMatch"
        },
        {
          "next": "setTestVariables",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to Developer Athan",
              "arguments": ["{{trigger.message.Body}}"],
              "type": "equal_to",
              "value": "Developer Athan"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{trigger.message.Body}}",
        "offset": {
          "x": -1490,
          "y": -330
        }
      }
    },
    {
      "name": "get_client_ddi",
      "type": "run-function",
      "transitions": [
        {
          "next": "setRegionCodeInitial",
          "event": "success"
        },
        {
          "next": "setRegionCodeInitial",
          "event": "fail"
        }
      ],
      "properties": {
        "service_sid": "ZS94a60054fb8b17808bdccffc44d1d2d0",
        "environment_sid": "ZE59c5da4f5ff7e98f2ce35f39df892e5d",
        "offset": {
          "x": -1880,
          "y": -320
        },
        "function_sid": "ZH1db2c25c65250de3c509732e25e56b31",
        "parameters": [
          {
            "value": "{{ trigger.message.ChannelAttributes.from}}",
            "key": "clientNumber"
          },
          {
            "value": "{{widgets.get_client_information.parsed.data.properties.idioma_fluxo}}",
            "key": "idioma"
          }
        ],
        "url": "https://serverless-functions-4443-dev.twil.io/ddi-identifier/identify"
      }
    },
    {
      "name": "setSubjectTemplate",
      "type": "set-variables",
      "transitions": [
        {
          "next": "sendToLoggerTemplate",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "{% if widgets.split_validate-comes-from-template.parsed.workerSkill %}send-to-{{widgets.split_validate-comes-from-template.parsed.workerSkill}}{% else %}send-to-Suporte_Geral_SMB1_SMB2_KAN1{% endif %}",
            "key": "subject"
          },
          {
            "value": "Resposta de um disparo, agente indisponível - Encaminhado para a fila",
            "key": "optionFlow"
          }
        ],
        "offset": {
          "x": -3400,
          "y": 1260
        }
      }
    },
    {
      "name": "checkIsWorkingTemplateWorker",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "setSubjectTemplateWorker",
          "event": "noMatch"
        },
        {
          "next": "setSubjectTemplateWorker",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to true",
              "arguments": ["{{widgets.isWorkingTemplate.parsed.isWorking}}"],
              "type": "equal_to",
              "value": "true"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.isWorkingTemplate.parsed.isWorking}}",
        "offset": {
          "x": -2680,
          "y": 960
        }
      }
    },
    {
      "name": "setSubjectTemplateWorker",
      "type": "set-variables",
      "transitions": [
        {
          "next": "sendToFlex",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "comes-from-template",
            "key": "subject"
          },
          {
            "value": "Resposta de um disparo - Encaminhado para o agente",
            "key": "optionFlow"
          }
        ],
        "offset": {
          "x": -2680,
          "y": 1240
        }
      }
    },
    {
      "name": "sendToLoggerTemplate",
      "type": "send-message",
      "transitions": [
        {
          "next": "sendToFlex",
          "event": "sent"
        },
        {
          "next": "sendToFlex",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -3400,
          "y": 1540
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "{% case flow.variables.regionCode %}\n{% when \" BR\" or \"BR\" %}\nAguarde um um instante enquanto eu encontro um logger para te atender\n{% when \" AR\" or \"AR\" %}\nEspera un momento mientras busco un registrador para ayudarte\n{% else %}\nWait a moment while I find a logger to assist you\n{% endcase %}"
      }
    },
    {
      "name": "setRegionCodeInitial",
      "type": "set-variables",
      "transitions": [
        {
          "next": "athsIntegration",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "{{widgets.get_client_ddi.parsed.regionCode}}",
            "key": "regionCode"
          }
        ],
        "offset": {
          "x": -2230,
          "y": -310
        }
      }
    },
    {
      "name": "setSearchValuePhone",
      "type": "set-variables",
      "transitions": [
        {
          "next": "get_client_information",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "phone",
            "key": "typeSearch"
          },
          {
            "value": "{% if trigger.message.ChannelAttributes.from %} {{trigger.message.ChannelAttributes.from}}{% else %}{{trigger.message.From}} {% endif %}",
            "key": "value"
          }
        ],
        "offset": {
          "x": -1520,
          "y": -620
        }
      }
    },
    {
      "name": "validateRegionCode",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "mainMenu",
          "event": "noMatch"
        },
        {
          "next": "messageSelectRegion",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "unset",
              "arguments": [
                "{{widgets.get_client_information.parsed.properties.idioma_fluxo}}"
              ],
              "type": "matches_any_of",
              "value": "unset, null"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.get_client_information.parsed.properties.idioma_fluxo}}",
        "offset": {
          "x": 390,
          "y": 210
        }
      }
    },
    {
      "name": "setSubjectSDR",
      "type": "set-variables",
      "transitions": [
        {
          "next": "sendToFlex",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "send-to-Comercial_Inbound",
            "key": "subject"
          },
          {
            "value": "1 - Conhecer nossos produtos - Contato possui negócios vinculados",
            "key": "optionFlow"
          }
        ],
        "offset": {
          "x": -190,
          "y": 2510
        }
      }
    },
    {
      "name": "Copy_of_setSubjectSDR",
      "type": "set-variables",
      "transitions": [
        {
          "next": "sendToFlex",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "send-to-Comercial_Inbound",
            "key": "subject"
          },
          {
            "value": "1 - Conhecer nossos produtos - Não cliente",
            "key": "optionFlow"
          }
        ],
        "offset": {
          "x": -190,
          "y": 5580
        }
      }
    },
    {
      "name": "setSubjectOption2NotCustomer",
      "type": "set-variables",
      "transitions": [
        {
          "next": "sendToFlex",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "send-to-Comercial_Inbound",
            "key": "subject"
          },
          {
            "value": "2 - Falar sobre sua assinatura - Cadastro não encontrado",
            "key": "optionFlow"
          }
        ],
        "offset": {
          "x": 570,
          "y": 3330
        }
      }
    },
    {
      "name": "setSubjectOption2CustomerWithoutClassification",
      "type": "set-variables",
      "transitions": [
        {
          "next": "sendToFlex",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "send-to-Comercial_Inbound",
            "key": "subject"
          },
          {
            "value": "2 - Falar sobre sua assinatura - Cliente sem classificação no cadastro",
            "key": "optionFlow"
          }
        ],
        "offset": {
          "x": 2730,
          "y": 2980
        }
      }
    },
    {
      "name": "setSubjectGuardian",
      "type": "set-variables",
      "transitions": [
        {
          "next": "sendToLogger",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "{%if widgets.httpGuardianActivity.parsed.to == \"worker\"%}send-to-guardian{% else %}send-to-{{widgets.get_client_information.parsed.data.properties.guardianSkill}}{% endif %}",
            "key": "subject"
          },
          {
            "value": "{%if widgets.httpGuardianActivity.parsed.to == \"worker\"%}2 - Quero tratar da renovação de contrato - Guardião online{% else %}2 - Quero tratar da renovação de contrato - Guardião não disponível{% endif %}",
            "key": "optionFlow"
          }
        ],
        "offset": {
          "x": 3300,
          "y": 3630
        }
      }
    },
    {
      "name": "setTestVariables",
      "type": "set-variables",
      "transitions": [
        {
          "next": "sendToFlexATHS",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "worker",
            "key": "transferTargetType"
          },
          {
            "value": "Teste de fluxo Athan Twilio",
            "key": "optionFlow"
          },
          {
            "value": "WK1fc520911036ebf31961547f5829510b",
            "key": "targetSid"
          }
        ],
        "offset": {
          "x": -1600,
          "y": -40
        }
      }
    },
    {
      "name": "validateKA",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "queueOptionsMenu",
          "event": "noMatch"
        },
        {
          "next": "httpKAActivity",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "isKA",
              "arguments": [
                "{{widgets.GetClientInformation.parsed.data.properties.squad_cs}}"
              ],
              "type": "matches_any_of",
              "value": "KA, ka, Ka, Key Account, key Account, key account, KEY ACCOUNT"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.GetClientInformation.parsed.data.properties.squad_cs}}",
        "offset": {
          "x": 2690,
          "y": 3310
        }
      }
    },
    {
      "name": "httpKAActivity",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "Copy_of_setSubjectKA",
          "event": "success"
        },
        {
          "next": "Copy_of_setSubjectKA",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 3050,
          "y": 3310
        },
        "method": "POST",
        "content_type": "application/json;charset=utf-8",
        "body": "{\n\"workerEmail\":\"{{widgets.get_client_information.parsed.data.properties.guardian}}\"\n}",
        "url": "https://serverless-functions-4443-dev.twil.io/utils/validate-worker-available"
      }
    },
    {
      "name": "Copy_of_setSubjectKA",
      "type": "set-variables",
      "transitions": [
        {
          "next": "sendToLogger",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "{%if widgets.httpKAActivity.parsed.to == \"worker\"%}send-to-guardian{% else %}send-to-{{widgets.get_client_information.parsed.data.properties.guardianSkill}}{% endif %}",
            "key": "subject"
          },
          {
            "value": "{%if widgets.httpKAActivity.parsed.to == \"worker\"%}Contato identificado como KA - direcionado para o guardião {{widgets.get_client_information.parsed.data.properties.guardian}}{% else %}Contato identificado como KA - direcionado para a fila do guardião {{widgets.get_client_information.parsed.data.properties.guardian}} pois ele está indisponível{% endif %}",
            "key": "optionFlow"
          }
        ],
        "offset": {
          "x": 3400,
          "y": 3310
        }
      }
    }
  ],
  "initial_state": "Trigger",
  "flags": {
    "allow_concurrent_calls": true
  }
}
