{
  "description": "A New Flow",
  "states": [
    {
      "name": "Trigger",
      "type": "trigger",
      "transitions": [
        {
          "next": "get_client_information",
          "event": "incomingMessage"
        },
        {
          "event": "incomingCall"
        },
        {
          "event": "incomingConversationMessage"
        },
        {
          "event": "incomingRequest"
        },
        {
          "event": "incomingParent"
        }
      ],
      "properties": {
        "offset": {
          "x": -430,
          "y": -740
        }
      }
    },
    {
      "name": "check_active_service",
      "type": "run-subflow",
      "transitions": [
        {
          "next": "split_active_service",
          "event": "completed"
        },
        {
          "next": "split_languages",
          "event": "failed"
        }
      ],
      "properties": {
        "flow_sid": "FWbc4d0a1ead1e571e7d22e4fe98c0597a",
        "flow_revision": "LatestPublished",
        "offset": {
          "x": -230,
          "y": 820
        },
        "parameters": [
          {
            "value": "{{ trigger.message.ChannelAttributes.from}}",
            "key": "phone"
          },
          {
            "value": "{{widgets.get_client_ddi.parsed.regionCode}}",
            "key": "region"
          }
        ]
      }
    },
    {
      "name": "split_active_service",
      "type": "split-based-on",
      "transitions": [
        {
          "event": "noMatch"
        },
        {
          "next": "split_languages_info",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value not_equal_to true",
              "arguments": ["{{widgets.check_active_service.endExecution}}"],
              "type": "not_equal_to",
              "value": "true"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.check_active_service.endExecution}}",
        "offset": {
          "x": -1370,
          "y": 820
        }
      }
    },
    {
      "name": "split_languages",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "proceed_with_portuguese",
          "event": "noMatch"
        },
        {
          "next": "proceed_with_english",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to US",
              "arguments": ["{{widgets.get_client_ddi.parsed.regionCode}}"],
              "type": "equal_to",
              "value": "US"
            }
          ]
        },
        {
          "next": "proceed_with_portuguese",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to BR",
              "arguments": ["{{widgets.get_client_ddi.parsed.regionCode}}"],
              "type": "equal_to",
              "value": "BR"
            }
          ]
        },
        {
          "next": "proceed_with_spanish",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to AR",
              "arguments": ["{{widgets.get_client_ddi.parsed.regionCode}}"],
              "type": "equal_to",
              "value": "AR"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.get_client_ddi.parsed.regionCode}}",
        "offset": {
          "x": -280,
          "y": 1360
        }
      }
    },
    {
      "name": "whatsapp_subflow_english",
      "type": "run-subflow",
      "transitions": [
        {
          "next": "set_variables_hubspot_language_us",
          "event": "completed"
        },
        {
          "next": "set_variables_hubspot_language_us",
          "event": "failed"
        }
      ],
      "properties": {
        "flow_sid": "FWce7e1dff7c09624cbf03f4b8749bc8ff",
        "flow_revision": "LatestPublished",
        "offset": {
          "x": -990,
          "y": 3100
        },
        "parameters": [
          {
            "value": "{{trigger.message.ChannelAttributes.from}}",
            "key": "customerPhone"
          },
          {
            "value": "{{trigger.message.MessageSid}}",
            "key": "callSid"
          },
          {
            "value": "{%if widgets.get_client_information.parsed.success%}{{widgets.get_client_information.parsed.data.properties.firstname}} {{widgets.get_client_information.parsed.data.properties.lastname}}{%else%}Cliente não encontrado{%endif%}",
            "key": "customer"
          },
          {
            "value": "{%if widgets.get_client_information.parsed.success%}{{widgets.get_client_information.parsed.data.properties.email}}{%else%}Cliente não encontrado{%endif%}",
            "key": "customerEmail"
          },
          {
            "value": "{%if widgets.get_client_information.parsed.success%}{{widgets.get_client_information.parsed.data.properties.company}}{%else%}Cliente não encontrado{%endif%}",
            "key": "organization"
          },
          {
            "value": "{%if widgets.get_client_information.parsed.success%}{{widgets.get_client_information.parsed.data.properties.guardiao}}{%else%}Cliente não encontrado{%endif%}",
            "key": "guardiao"
          }
        ]
      }
    },
    {
      "name": "whatsapp_subflow_spanish",
      "type": "run-subflow",
      "transitions": [
        {
          "next": "set_variables_hubspot_language_ar",
          "event": "completed"
        },
        {
          "next": "set_variables_hubspot_language_ar",
          "event": "failed"
        }
      ],
      "properties": {
        "flow_sid": "FW9ab65b655a27e2c0bd5528517c04aac9",
        "flow_revision": "LatestPublished",
        "offset": {
          "x": 840,
          "y": 3780
        },
        "parameters": [
          {
            "value": "{{trigger.message.ChannelAttributes.from}}",
            "key": "customerPhone"
          },
          {
            "value": "{{trigger.message.MessageSid}}",
            "key": "callSid"
          },
          {
            "value": "{%if widgets.get_client_information.parsed.success%}{{widgets.get_client_information.parsed.data.properties.firstname}} {{widgets.get_client_information.parsed.data.properties.lastname}}{%else%}Cliente não encontrado{%endif%}",
            "key": "customer"
          },
          {
            "value": "{%if widgets.get_client_information.parsed.success%}{{widgets.get_client_information.parsed.data.properties.email}}{%else%}Cliente não encontrado{%endif%}",
            "key": "customerEmail"
          },
          {
            "value": "{%if widgets.get_client_information.parsed.success%}{{widgets.get_client_information.parsed.data.properties.company}}{%else%}Cliente não encontrado{%endif%}",
            "key": "organization"
          },
          {
            "value": "{%if widgets.get_client_information.parsed.success%}{{widgets.get_client_information.parsed.data.properties.guardian}}{%else%}Cliente não encontrado{%endif%}",
            "key": "guardiao"
          }
        ]
      }
    },
    {
      "name": "whatsapp_subflow_portuguese",
      "type": "run-subflow",
      "transitions": [
        {
          "next": "set_variables_hubspot_language_br",
          "event": "completed"
        },
        {
          "next": "set_variables_hubspot_language_br",
          "event": "failed"
        }
      ],
      "properties": {
        "flow_sid": "FWdf1ad1f12315e3952dffd677d111af87",
        "flow_revision": "LatestPublished",
        "offset": {
          "x": -80,
          "y": 3550
        },
        "parameters": [
          {
            "value": "{{trigger.message.MessageSid}}",
            "key": "callSid"
          },
          {
            "value": "{{trigger.message.ChannelAttributes.from}}",
            "key": "customerPhone"
          },
          {
            "value": "{%if widgets.get_client_information.parsed.success%}{{widgets.get_client_information.parsed.data.properties.firstname}} {{widgets.get_client_information.parsed.data.properties.lastname}}{%else%}Cliente não encontrado{%endif%}",
            "key": "customer"
          },
          {
            "value": "{%if widgets.get_client_information.parsed.success%}{{widgets.get_client_information.parsed.data.properties.email}}{%else%}Cliente não encontrado{%endif%}",
            "key": "customerEmail"
          },
          {
            "value": "{%if widgets.get_client_information.parsed.success%}{{widgets.get_client_information.parsed.data.properties.company}}{%else%}Cliente não encontrado{%endif%}",
            "key": "organization"
          },
          {
            "value": "{%if widgets.get_client_information.parsed.success%}{{widgets.get_client_information.parsed.data.properties.guardian}}{%else%}Cliente não encontrado{%endif%}",
            "key": "guardiao"
          }
        ]
      }
    },
    {
      "name": "get_client_ddi",
      "type": "run-function",
      "transitions": [
        {
          "next": "athsIntegration",
          "event": "success"
        },
        {
          "next": "athsIntegration",
          "event": "fail"
        }
      ],
      "properties": {
        "service_sid": "ZS94a60054fb8b17808bdccffc44d1d2d0",
        "environment_sid": "ZE59c5da4f5ff7e98f2ce35f39df892e5d",
        "offset": {
          "x": 460,
          "y": -40
        },
        "function_sid": "ZH1db2c25c65250de3c509732e25e56b31",
        "parameters": [
          {
            "value": "{{ trigger.message.ChannelAttributes.from}}",
            "key": "clientNumber"
          },
          {
            "value": "{{widgets.get_client_information.parsed.data.properties.idioma_fluxo}}",
            "key": "idioma"
          }
        ],
        "url": "https://serverless-functions-4443-dev.twil.io/ddi-identifier/identify"
      }
    },
    {
      "name": "split_select_language",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "whatsapp_subflow_portuguese",
          "event": "noMatch"
        },
        {
          "next": "whatsapp_subflow_portuguese",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to 1",
              "arguments": ["{{widgets.proceed_with_portuguese.inbound.Body}}"],
              "type": "equal_to",
              "value": "1"
            }
          ]
        },
        {
          "next": "whatsapp_subflow_english",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to 2",
              "arguments": ["{{widgets.proceed_with_portuguese.inbound.Body}}"],
              "type": "equal_to",
              "value": "2"
            }
          ]
        },
        {
          "next": "whatsapp_subflow_spanish",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to 3",
              "arguments": ["{{widgets.proceed_with_portuguese.inbound.Body}}"],
              "type": "equal_to",
              "value": "3"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.proceed_with_portuguese.inbound.Body}}",
        "offset": {
          "x": -210,
          "y": 2160
        }
      }
    },
    {
      "name": "proceed_with_portuguese",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "split_select_language",
          "event": "incomingMessage"
        },
        {
          "next": "whatsapp_subflow_portuguese",
          "event": "timeout"
        },
        {
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": -140,
          "y": 1860
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "body": "Essa conversa será em Português.\n\nDeseja selecionar outra língua?\n\n1- Se quer continuar em português\n\n2 - If you want to continue in english\n\n3 - Si quieres continuar en español",
        "timeout": "3600"
      }
    },
    {
      "name": "proceed_with_spanish",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "split_select_spanish",
          "event": "incomingMessage"
        },
        {
          "next": "whatsapp_subflow_spanish",
          "event": "timeout"
        },
        {
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 810,
          "y": 1720
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "body": "Esta conversación será en Español.\n\n¿Quieres seleccionar otro idioma?\n\n1- Se quer continuar em português\n\n2 - If you want to continue in english\n\n3 - Si quieres continuar en español",
        "timeout": "3600"
      }
    },
    {
      "name": "split_select_spanish",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "whatsapp_subflow_spanish",
          "event": "noMatch"
        },
        {
          "next": "whatsapp_subflow_portuguese",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to 1",
              "arguments": ["{{widgets.proceed_with_spanish.inbound.Body}}"],
              "type": "equal_to",
              "value": "1"
            }
          ]
        },
        {
          "next": "whatsapp_subflow_english",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to 2",
              "arguments": ["{{widgets.proceed_with_spanish.inbound.Body}}"],
              "type": "equal_to",
              "value": "2"
            }
          ]
        },
        {
          "next": "whatsapp_subflow_spanish",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to 3",
              "arguments": ["{{widgets.proceed_with_spanish.inbound.Body}}"],
              "type": "equal_to",
              "value": "3"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.proceed_with_spanish.inbound.Body}}",
        "offset": {
          "x": 930,
          "y": 2590
        }
      }
    },
    {
      "name": "proceed_with_english",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "split_select_english",
          "event": "incomingMessage"
        },
        {
          "next": "whatsapp_subflow_english",
          "event": "timeout"
        },
        {
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": -1310,
          "y": 1780
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "body": "This conversation will be in English.\n\nDo you want to select another language?\n\n1- Se quer continuar em português\n\n2 - If you want to continue in english\n\n3 - Si quieres continuar en español",
        "timeout": "3600"
      }
    },
    {
      "name": "split_select_english",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "whatsapp_subflow_english",
          "event": "noMatch"
        },
        {
          "next": "whatsapp_subflow_english",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to 1",
              "arguments": ["{{widgets.proceed_with_english.inbound.Body}}"],
              "type": "equal_to",
              "value": "1"
            }
          ]
        },
        {
          "next": "whatsapp_subflow_portuguese",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to 2",
              "arguments": ["{{widgets.proceed_with_english.inbound.Body}}"],
              "type": "equal_to",
              "value": "2"
            }
          ]
        },
        {
          "next": "whatsapp_subflow_spanish",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to 3",
              "arguments": ["{{widgets.proceed_with_english.inbound.Body}}"],
              "type": "equal_to",
              "value": "3"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.proceed_with_english.inbound.Body}}",
        "offset": {
          "x": -1510,
          "y": 2070
        }
      }
    },
    {
      "name": "get_client_information",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "validateTestAthan",
          "event": "success"
        },
        {
          "next": "validateTestAthan",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -300,
          "y": -370
        },
        "method": "POST",
        "content_type": "application/json;charset=utf-8",
        "body": "{\n\"typeSearch\": \"phone\",\n\"clientEmail\": \" {{trigger.message.ChannelAttributes.from}}\"\n}",
        "url": "https://serverless-functions-4443-dev.twil.io/hubspot-integration/search-client"
      }
    },
    {
      "name": "validateTaskCsat",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "checkIfIsCsat",
          "event": "success"
        },
        {
          "next": "checkIfIsCsat",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 640,
          "y": -860
        },
        "method": "POST",
        "content_type": "application/json;charset=utf-8",
        "body": "{\n\"client_number\": \"{{trigger.message.ChannelAttributes.from}}\"\n}",
        "url": "https://serverless-plugin-survey-9053-dev.twil.io/read_survey_task"
      }
    },
    {
      "name": "checkIfIsCsat",
      "type": "split-based-on",
      "transitions": [
        {
          "event": "noMatch"
        },
        {
          "next": "runCsatSubFlow",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "true",
              "arguments": ["{{widgets.validateTaskCsat.body}}"],
              "type": "equal_to",
              "value": "true"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.validateTaskCsat.body}}",
        "offset": {
          "x": 1000,
          "y": -860
        }
      }
    },
    {
      "name": "runCsatSubFlow",
      "type": "run-subflow",
      "transitions": [
        {
          "event": "completed"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "flow_sid": "FWe58b62d8d3c04591777b1b5eaf97e011",
        "flow_revision": "LatestPublished",
        "offset": {
          "x": 1370,
          "y": -860
        },
        "parameters": [
          {
            "value": "{{trigger.message.Body}}",
            "key": "message"
          }
        ]
      }
    },
    {
      "name": "function_save_language_us",
      "type": "run-function",
      "transitions": [
        {
          "event": "success"
        },
        {
          "event": "fail"
        }
      ],
      "properties": {
        "service_sid": "ZS94a60054fb8b17808bdccffc44d1d2d0",
        "environment_sid": "ZE59c5da4f5ff7e98f2ce35f39df892e5d",
        "offset": {
          "x": -1020,
          "y": 3630
        },
        "function_sid": "ZH040933d9f10d395cd7b32a9ffd5fdd1d",
        "parameters": [
          {
            "value": "{{flow.variables.hubspot_id}}",
            "key": "hubspot_id"
          },
          {
            "value": "US",
            "key": "language"
          }
        ],
        "url": "https://serverless-functions-4443-dev.twil.io/hubspot-integration/save-language"
      }
    },
    {
      "name": "function_save_language__br",
      "type": "run-function",
      "transitions": [
        {
          "event": "success"
        },
        {
          "event": "fail"
        }
      ],
      "properties": {
        "service_sid": "ZS94a60054fb8b17808bdccffc44d1d2d0",
        "environment_sid": "ZE59c5da4f5ff7e98f2ce35f39df892e5d",
        "offset": {
          "x": -70,
          "y": 4100
        },
        "function_sid": "ZH040933d9f10d395cd7b32a9ffd5fdd1d",
        "parameters": [
          {
            "value": "{{flow.variables.hubspot_id}}",
            "key": "hubspot_id"
          },
          {
            "value": "BR",
            "key": "language"
          }
        ],
        "url": "https://serverless-functions-4443-dev.twil.io/hubspot-integration/save-language"
      }
    },
    {
      "name": "function_save_language__es",
      "type": "run-function",
      "transitions": [
        {
          "event": "success"
        },
        {
          "event": "fail"
        }
      ],
      "properties": {
        "service_sid": "ZS94a60054fb8b17808bdccffc44d1d2d0",
        "environment_sid": "ZE59c5da4f5ff7e98f2ce35f39df892e5d",
        "offset": {
          "x": 760,
          "y": 4350
        },
        "function_sid": "ZH040933d9f10d395cd7b32a9ffd5fdd1d",
        "parameters": [
          {
            "value": "{{flow.variables.hubspot_id}}",
            "key": "hubspot_id"
          },
          {
            "value": "AR",
            "key": "language"
          }
        ],
        "url": "https://serverless-functions-4443-dev.twil.io/hubspot-integration/save-language"
      }
    },
    {
      "name": "split_languages_info",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "split_languages",
          "event": "noMatch"
        },
        {
          "next": "whatsapp_subflow_english",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to US",
              "arguments": [
                "{{widgets.get_client_information.parsed.data.properties.idioma_fluxo}}"
              ],
              "type": "equal_to",
              "value": "US"
            }
          ]
        },
        {
          "next": "whatsapp_subflow_portuguese",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to BR",
              "arguments": [
                "{{widgets.get_client_information.parsed.data.properties.idioma_fluxo}}"
              ],
              "type": "equal_to",
              "value": "BR"
            }
          ]
        },
        {
          "next": "whatsapp_subflow_spanish",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to AR",
              "arguments": [
                "{{widgets.get_client_information.parsed.data.properties.idioma_fluxo}}"
              ],
              "type": "equal_to",
              "value": "AR"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.get_client_information.parsed.data.properties.idioma_fluxo}}",
        "offset": {
          "x": -2160,
          "y": 1400
        }
      }
    },
    {
      "name": "set_variables_hubspot_language_br",
      "type": "set-variables",
      "transitions": [
        {
          "next": "function_save_language__br",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "{% if widgets.get_client_information.parsed.success %}{{widgets.get_client_information.parsed.data.properties.hs_object_id}}{% elsif widgets.whatsapp_subflow_portuguese.hubspot_id %}{{widgets.whatsapp_subflow_portuguese.hubspot_id}}{% else %}unset{% endif %}",
            "key": "hubspot_id"
          }
        ],
        "offset": {
          "x": 180,
          "y": 3830
        }
      }
    },
    {
      "name": "set_variables_hubspot_language_us",
      "type": "set-variables",
      "transitions": [
        {
          "next": "function_save_language_us",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "{% if widgets.get_client_information.parsed.success %}{{widgets.get_client_information.parsed.data.properties.hs_object_id}}{% elsif widgets.whatsapp_subflow_english.hubspot_id %}{{widgets.whatsapp_subflow_english.hubspot_id}}{% else %}unset{% endif %}",
            "key": "hubspot_id"
          }
        ],
        "offset": {
          "x": -770,
          "y": 3350
        }
      }
    },
    {
      "name": "set_variables_hubspot_language_ar",
      "type": "set-variables",
      "transitions": [
        {
          "next": "function_save_language__es",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "{% if widgets.get_client_information.parsed.success %}{{widgets.get_client_information.parsed.data.properties.hs_object_id}}{% elsif widgets.whatsapp_subflow_spanish.hubspot_id %}{{widgets.whatsapp_subflow_spanish.hubspot_id}}{% else %}unset{% endif %}",
            "key": "hubspot_id"
          }
        ],
        "offset": {
          "x": 1050,
          "y": 4090
        }
      }
    },
    {
      "name": "validate-comes-from-template",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "split_validate-comes-from-template",
          "event": "success"
        },
        {
          "next": "split_validate-comes-from-template",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -300,
          "y": 530
        },
        "method": "GET",
        "content_type": "application/x-www-form-urlencoded;charset=utf-8",
        "parameters": [
          {
            "value": "{{widgets.get_client_information.parsed.data.properties.atendimento_ativo_por}}",
            "key": "workerEmail"
          },
          {
            "value": "{{widgets.get_client_information.parsed.data.properties.hs_object_id}}",
            "key": "hubspotId"
          }
        ],
        "url": "https://serverless-functions-4443-dev.twil.io/hubspot-integration/validate-comes-from-template"
      }
    },
    {
      "name": "split_validate-comes-from-template",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "split_active_service",
          "event": "noMatch"
        },
        {
          "next": "check_active_service",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "worker",
              "arguments": [
                "{{widgets.validate-comes-from-template.parsed.to}}"
              ],
              "type": "equal_to",
              "value": "worker"
            }
          ]
        },
        {
          "next": "isWorking",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "queue",
              "arguments": [
                "{{widgets.validate-comes-from-template.parsed.to}}"
              ],
              "type": "equal_to",
              "value": "queue"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.validate-comes-from-template.parsed.to}}",
        "offset": {
          "x": 350,
          "y": 550
        }
      }
    },
    {
      "name": "send_to_flex_queue",
      "type": "send-to-flex",
      "transitions": [
        {
          "event": "callComplete"
        },
        {
          "event": "failedToEnqueue"
        },
        {
          "event": "callFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 1640,
          "y": 1110
        },
        "workflow": "WW0ee76b16197f7eb3b936f8450ed66b60",
        "channel": "TC38f2a7207058a506929181a479717c36",
        "attributes": "{\n{% if flow.variables.transferTargetType and flow.variables.targetSid %}\n\"transferTargetType\": \"{{flow.variables.transferTargetType}}\",\n \"targetSid\": \"{{flow.variables.targetSid}}\",\n{% endif %}\n\"subject\": \"send-to-support\",\n \"clientInformation\": {{widgets.get_client_information.parsed.data.properties|to_json}},\n \"customers\": {\n \"phone\": \"{{trigger.message.ChannelAttributes.from | replace: 'whatsapp:', ''}}\",\n {%if widgets.get_client_information.parsed.success%}\n \"name\": \"{{widgets.get_client_information.parsed.data.properties.firstname}} {{widgets.get_client_information.parsed.data.properties.lastname}}\",\n \"organization\": \"{{widgets.get_client_information.parsed.data.properties.company}}\",\n \"email\": \"{{widgets.get_client_information.parsed.data.properties.email}}\"\n    {%else%}\n \"name\": \"Cliente não encontrado\",\n \"organization\": \"Cliente não encontrado\",\n \"email\": \"Cliente não encontrado\"\n    {%endif%}\n  },\n \"conversations\": {\n \"external_contact\": \"{{trigger.message.ChannelAttributes.twilioNumber | replace: 'whatsapp:', ''}}\",\n \"selected_option_on_flow\": \"Resposta de um disparo ativo - agente indisponível - direcionado para a fila\",\n {%if widgets.get_client_information.parsed.success%}\n \"conversation_attribute_2\": \"{{widgets.get_client_information.parsed.data.properties.guardian}}\"\n    {%else%}\n \"conversation_attribute_2\": \"Cliente não encontrado\"\n    {%endif%}\n  }\n  }"
      }
    },
    {
      "name": "isWorking",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "checkIsWorking",
          "event": "success"
        },
        {
          "next": "checkIsWorking",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1300,
          "y": 620
        },
        "method": "POST",
        "content_type": "application/x-www-form-urlencoded;charset=utf-8",
        "url": "https://serverless-functions-4443-dev.twil.io/utils/check-business-hour"
      }
    },
    {
      "name": "checkIsWorking",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "outBusinessHour1",
          "event": "noMatch"
        },
        {
          "next": "send_to_flex_queue",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "true",
              "arguments": ["{{widgets.isWorking.parsed.success}}"],
              "type": "equal_to",
              "value": "true"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.isWorking.parsed.success}}",
        "offset": {
          "x": 1300,
          "y": 840
        }
      }
    },
    {
      "name": "outBusinessHour1",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1000,
          "y": 1110
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "{{widgets.isWorking.parsed.offlineMessage}}"
      }
    },
    {
      "name": "athsIntegration",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "athsIntegrationCheck",
          "event": "success"
        },
        {
          "next": "athsIntegrationCheck",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -350,
          "y": 190
        },
        "method": "POST",
        "content_type": "application/json;charset=utf-8",
        "body": "{ \"clientNumber\": \"{{trigger.message.ChannelAttributes.from}}\", \"companyNumber\": \"{{trigger.message.ChannelAttributes.twilioNumber}}\", \"channelSid\": \"{{trigger.message.ChannelSid}}\", \"chatServiceSid\": \"{{trigger.message.InstanceSid}}\" }",
        "url": "https://serverless-functions-4443-dev.twil.io/integrations/aths/aths-integration"
      }
    },
    {
      "name": "athsIntegrationCheck",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "validate-comes-from-template",
          "event": "noMatch"
        },
        {
          "next": "setAthsVariables",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "true",
              "arguments": ["{{widgets.athsIntegration.parsed.success}}"],
              "type": "equal_to",
              "value": "true"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.athsIntegration.parsed.success}}",
        "offset": {
          "x": 60,
          "y": 240
        }
      }
    },
    {
      "name": "setAthsVariables",
      "type": "set-variables",
      "transitions": [
        {
          "next": "sendToFlexAths",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "value": "{%if widgets.athsIntegration.parsed.data.type_studio_integration == \"agent\" %}worker{%else%}queue{%endif%}",
            "key": "transferTargetType"
          },
          {
            "value": "{{widgets.athsIntegration.parsed.data.studio_integration_route}}",
            "key": "targetSid"
          }
        ],
        "offset": {
          "x": 410,
          "y": 240
        }
      }
    },
    {
      "name": "sendToFlexAths",
      "type": "send-to-flex",
      "transitions": [
        {
          "event": "callComplete"
        },
        {
          "event": "failedToEnqueue"
        },
        {
          "event": "callFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 780,
          "y": 240
        },
        "workflow": "WW0ee76b16197f7eb3b936f8450ed66b60",
        "channel": "TC38f2a7207058a506929181a479717c36",
        "attributes": "{\n \"name\": \"{{trigger.message.ChannelAttributes.from}}\",\n \"transferTargetType\": \"{{flow.variables.transferTargetType}}\",\n \"targetSid\": \"{{flow.variables.targetSid}}\",\n \"conversations\": {\n \"external_contact\": \"{{trigger.message.ChannelAttributes.twilioNumber}}\",\n \"in_business_hours\": \"yes\",\n \"channel\": \"{{trigger.message.ChannelAttributes.channel_type}}\"\n  },\n \"customers\": { \"phone\": \"{{trigger.message.ChannelAttributes.from}}\" }\n}"
      }
    },
    {
      "name": "validateTestAthan",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "get_client_ddi",
          "event": "noMatch"
        },
        {
          "next": "sendToFlexTest",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Developer Athan",
              "arguments": ["{{trigger.message.Body}}"],
              "type": "equal_to",
              "value": "Developer Athan"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{trigger.message.Body}}",
        "offset": {
          "x": 500,
          "y": -480
        }
      }
    },
    {
      "name": "sendToFlexTest",
      "type": "send-to-flex",
      "transitions": [
        {
          "event": "callComplete"
        },
        {
          "event": "failedToEnqueue"
        },
        {
          "event": "callFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 1030,
          "y": -230
        },
        "workflow": "WW0ee76b16197f7eb3b936f8450ed66b60",
        "channel": "TC38f2a7207058a506929181a479717c36",
        "attributes": "{\n\"transferTargetType\": \"worker\",\n\"targetSid\": \"WK1fc520911036ebf31961547f5829510b\",\n\"subject\": \"send-to-support\",\n\"clientInformation\": {{widgets.get_client_information.parsed.data.properties|to_json}},\n\"deals\": \"{{widgets.getDeals.parsed.deals}}\",\n\"customers\": {\n\"phone\": \"{{trigger.message.ChannelAttributes.from | replace: 'whatsapp:', ''}}\",\n{%if widgets.get_client_information.parsed.success%}\n\"name\": \"{{widgets.get_client_information.parsed.data.properties.firstname}} {{widgets.get_client_information.parsed.data.properties.lastname}}\",\n\"organization\": \"{{widgets.get_client_information.parsed.data.properties.company}}\",\n\"email\": \"{{widgets.get_client_information.parsed.data.properties.email}}\"\n   {%else%}\n\"name\": \"Cliente não encontrado\",\n\"organization\": \"Cliente não encontrado\",\n\"email\": \"Cliente não encontrado\"\n   {%endif%}\n },\n\"conversations\": {\n\"external_contact\": \"{{trigger.message.ChannelAttributes.twilioNumber | replace: 'whatsapp:', ''}}\",\n\"selected_option_on_flow\": \"Resposta de um disparo ativo - agente indisponível - direcionado para a fila\",\n{%if widgets.get_client_information.parsed.success%}\n\"conversation_attribute_2\": \"{{widgets.get_client_information.parsed.data.properties.guardian}}\"\n   {%else%}\n\"conversation_attribute_2\": \"Cliente não encontrado\"\n   {%endif%}\n }\n }"
      }
    }
  ],
  "initial_state": "Trigger",
  "flags": {
    "allow_concurrent_calls": true
  }
}
